# Makefile para testing con Docker
.PHONY: test test-build test-run test-clean test-shell

# Variables
IMAGE_NAME = workflow-test
CONTAINER_NAME = workflow-test-container

# Construir imagen de test
test-build:
	@echo "ğŸ”¨ Construyendo imagen de test..."
	docker build -f Dockerfile.test -t $(IMAGE_NAME) .
	@echo "âœ… Imagen construida: $(IMAGE_NAME)"

# Ejecutar tests
test-run: test-build
	@echo "ğŸ§ª Ejecutando tests..."
	docker run --rm --name $(CONTAINER_NAME) $(IMAGE_NAME)
	@echo "âœ… Tests completados"

# Ejecutar tests con shell interactivo
test-shell: test-build
	@echo "ğŸš Iniciando shell interactivo para testing..."
	docker run --rm -it --name $(CONTAINER_NAME) $(IMAGE_NAME) /bin/bash

# Limpiar recursos de test
test-clean:
	@echo "ğŸ§¹ Limpiando recursos de test..."
	docker rmi $(IMAGE_NAME) 2>/dev/null || true
	docker container prune -f 2>/dev/null || true
	@echo "âœ… Limpieza completada"

# Test rÃ¡pido (solo comandos bÃ¡sicos)
test-quick: test-build
	@echo "âš¡ Ejecutando test rÃ¡pido..."
	docker run --rm --name $(CONTAINER_NAME) $(IMAGE_NAME) bash -c "workflow version && workflow add 'Quick test' 1.0 && workflow status && workflow report --workflow"
	@echo "âœ… Test rÃ¡pido completado"

# Test de migraciÃ³n especÃ­fico
test-migration: test-build
	@echo "ğŸ”„ Ejecutando test de migraciÃ³n..."
	docker run --rm --name $(CONTAINER_NAME) $(IMAGE_NAME) bash -c "echo 'Creando datos JSON viejos...' && mkdir -p ~/.workflow && echo '[{\"id\":1,\"description\":\"Old task\",\"hours\":2.0,\"category\":\"general\",\"date\":\"2025-07-21\",\"created_at\":\"2025-07-21T10:00:00Z\"}]' > ~/.workflow/tasks.json && echo 'Ejecutando migraciÃ³n...' && workflow migrate --dry-run && echo 'MigraciÃ³n exitosa!'"
	@echo "âœ… Test de migraciÃ³n completado"

# Test de instalaciÃ³n sin Go
test-no-go:
	@echo "ğŸš« Ejecutando test de instalaciÃ³n sin Go..."
	docker build -f Dockerfile.test-no-go -t workflow-test-no-go .
	docker run --rm --name workflow-test-no-go-container workflow-test-no-go /test/test-no-go.sh
	@echo "âœ… Test de instalaciÃ³n sin Go completado"

# Test de producciÃ³n exhaustivo
test-production:
	@echo "ğŸ­ Ejecutando test de producciÃ³n exhaustivo..."
	docker build -f Dockerfile.test-no-go -t workflow-test-no-go .
	docker run --rm --name workflow-test-production-container workflow-test-no-go /test/test-production.sh
	@echo "âœ… Test de producciÃ³n completado"

# Ayuda
test-help:
	@echo "ğŸ“‹ Comandos disponibles para testing:"
	@echo "  make test-build     - Construir imagen de test"
	@echo "  make test-run       - Ejecutar todos los tests"
	@echo "  make test-shell     - Shell interactivo para testing"
	@echo "  make test-quick     - Test rÃ¡pido (solo bÃ¡sicos)"
	@echo "  make test-migration - Test especÃ­fico de migraciÃ³n"
	@echo "  make test-no-go     - Test de instalaciÃ³n sin Go"
	@echo "  make test-production - Test de producciÃ³n exhaustivo"
	@echo "  make test-clean     - Limpiar recursos de test"
	@echo "  make test-help      - Mostrar esta ayuda" 